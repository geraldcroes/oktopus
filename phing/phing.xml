<?xml version="1.0" encoding="UTF-8"?>

<project name="Oktopus" default="doc">
    <taskdef name="atoum" classpath="./" classname="AtoumTask"/>

    <!-- ============================================  -->
    <!-- Target: preparebuild                          -->
    <!-- ============================================  -->
    <target name="preparebuild">
        <mkdir dir="../build" />
    </target>

    <!-- ============================================  -->
    <!-- Target: Test                                  -->
    <!-- ============================================  -->
    <target name="update_atoum">
        <echo msg="Updating Atoum" />
        <exec command="php -n ../tests/mageekguy.atoum.phar -v" outputProperty="atoum_version_before" />
        <httpget url="http://downloads.atoum.org/nightly/mageekguy.atoum.phar" dir="../tests" />
        <exec command="php -n ../tests/mageekguy.atoum.phar -v" outputProperty="atoum_version_after" />
        <if>
            <or>
                <equals arg1="${atoum_version_before}" arg2="${atoum_version_after}" />
            </or>
            <then>
                <echo message="No need to update ATOUM, versions are equals" />
                <echo message="${atoum_version_before}" />
            </then>
            <else>
                <echo message="Updating ATOUM" />
                <echo message="From ${atoum_version_before}" />
                <echo message="TO   ${atoum_version_after}" />
                <!--
                <exec command="git add ../tests/mageekguy.atoum.phar" />
                <exec command='git commit -m "${atoum_version_after}" '/>
                -->
            </else>
        </if>
    </target>

    <!-- ============================================  -->
    <!-- Target: Test                                  -->
    <!-- ============================================  -->
    <target name="test">
        <echo msg="Launching tests" />
        <atoum
                atoumpharpath="../tests/mageekguy.atoum.phar">
            <fileset dir="../tests/container">
                <include name="**/*.php" />
            </fileset>
            <fileset dir="../tests/engine">
                <include name="**/*.php" />
            </fileset>
        </atoum>
    </target>

    <!-- ============================================  -->
    <!-- Target: Doc                               -->
    <!-- ============================================  -->
    <target name="doc">
        <docblox title="API Documentation" destdir="../Documentation">
            <fileset dir="../Oktopus">
                <include name="**/*.php" />
            </fileset>
        </docblox>
    </target>

    <!-- ============================================  -->
    <!-- Target: Phar                               -->
    <!-- ============================================  -->
    <target name="phar" depends="test,preparebuild">
        <pharpackage
          destfile="../build/oktopus.phar"
          basedir="../"
          stub="stub.php"
          compression="bzip2"
          >
          <fileset dir="../Oktopus">
            <include name="**/**" />
          </fileset>
          <metadata>
            <element name="version" value="0.1"/>
            <element name="authors">
              <element name="Gérald Croës">
                <element name="e-mail" value="gerald@croes.org" />
              </element>
            </element>
          </metadata>
        </pharpackage>
    </target>
</project>
